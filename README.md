# Gait Analysis Scripts

This document explains how to run the Python scripts in this folder for gait analysis.
For the Docker-based development environment, see `README_DedEnvironment.md`.

## Requirements

- Python 3.11
- `ffmpeg` installed and available on `PATH`
- Python packages:
  - `opencv-python`
  - `mediapipe`
  - `numpy`
  - `pandas`
  - `matplotlib`
  - `seaborn`

## Files

- `gait_analysis_batch.py`  
  Batch-process videos listed in `batch_config.json`, outputting a CSV and a tracked MP4 per video.
- `plot_gait.py`  
  Plot hip/knee angles and ankle height from a CSV generated by `gait_analysis_batch.py`.

## 1) Batch gait analysis (video -> CSV + tracked MP4)

Create a JSON config file named `batch_config.json`:

```json
[
  {
    "input_video": "sample.mp4",
    "start_sec": 5,
    "end_sec": 15
  }
]
```

### Windows path examples

If your videos are on the host (e.g., `C:\Python\mmpose\mp4`), you can use either style:

```json
[
  {
    "input_video": "C:\\Python\\mmpose\\mp4\\sample.mp4",
    "start_sec": 5,
    "end_sec": 15
  }
]
```

```json
[
  {
    "input_video": "C:/Python/mmpose/mp4/sample.mp4",
    "start_sec": 5,
    "end_sec": 15
  }
]
```

### Docker mount example (Windows host)

When running inside Docker, mount the host folder and use the container path.
The compose file supports a flexible host folder via `MP4_DIR`.

```yaml
services:
  mmpose-dev:
    volumes:
      - "${MP4_DIR:-C:/Python/mmpose/mp4}:/data/mp4"
```

Set the host folder per run:

```bash
MP4_DIR="C:/Python/mmpose/mp4" docker compose up -d
```

Then set `input_video` to the container path:

```json
[
  {
    "input_video": "/data/mp4/sample.mp4",
    "start_sec": 5,
    "end_sec": 15
  }
]
```

### Output folder (host -> container)

The tracked videos and CSVs are saved under `/output` in the container.
The host folder can be changed via `OUTPUT_DIR`.

```yaml
services:
  mmpose-dev:
    volumes:
      - "${OUTPUT_DIR:-C:/Python/mmpose/output}:/output"
```

Example:

```bash
OUTPUT_DIR="C:/Python/mmpose/output" docker compose up -d
```

Run the batch script:

```bash
python gait_analysis_batch.py
```

Outputs are created next to the input video:

- `sample_5s-15s_gait.csv`
- `sample_5s-15s_tracked.mp4`

### Headless mode (no GUI window)

If you are running in Docker/SSH/CI, disable the OpenCV window:

```bash
SHOW_WINDOW=0 python gait_analysis_batch.py
```

## 2) Plot gait data (CSV -> graphs)

Use a CSV generated by the batch script:

```bash
python plot_gait.py sample_5s-15s_gait.csv
```

Alternatively, set the CSV via environment variable:

```bash
CSV_FILE=sample_5s-15s_gait.csv python plot_gait.py
```

### Plot using batch_config.json

You can plot all CSVs generated by the last batch run:

```bash
python plot_gait.py --batch-config batch_config.json
```

If your output is in a different folder:

```bash
python plot_gait.py --batch-config batch_config.json --output-dir /output
```

### Save plots to files (PNG/PDF)

Save plots without GUI:

```bash
python plot_gait.py --batch-config batch_config.json --save --save-formats png,pdf
```

Change the save folder:

```bash
python plot_gait.py --batch-config batch_config.json --save --save-dir /output
```

## Notes

- If `ffmpeg` is not installed, `gait_analysis_batch.py` will print an error and stop.
- If the video cannot be opened, the script will print an error and skip the file.
- For Japanese labels in plots, the Docker image includes `fonts-noto-cjk`. You can override the font via `PLOT_FONT_FAMILY`.
